/* Users can (dis)allow different groups of cookies. */
const COOKIE_CATEGORIES = {
    analytics: ['_ga', '_ga_' + window.GA_CONTAINER_ID],
    /* Essential cookies
     *
     * Essential cookies cannot be deselected, but we want our cookie code to
     * only allow adding cookies that are documented in this object, so they need
     * to be added here.
     */
    essential: [window.GA_COOKIE_NAME]
};
/*
 * Default cookie preferences if user has no cookie preferences.
 *
 * Note that this doesn't include a key for essential cookies, essential
 * cookies cannot be disallowed. If the object contains { essential: false }
 * this will be ignored.
 */
const DEFAULT_COOKIE_CONSENT = {
    analytics: false,
    version: window.GDS_CONSENT_COOKIE_VERSION
};
/** Return the user's cookie preferences.
 *
 * If the consent cookie is malformed, or not present,
 * returns null.
 */
export function getConsentCookie() {
    const consentCookie = getCookie(window.GA_COOKIE_NAME);
    let consentCookieObj;
    if (consentCookie) {
        try {
            consentCookieObj = JSON.parse(decodeURIComponent(consentCookie));
        }
        catch (err) {
            return null;
        }
    }
    else {
        return null;
    }
    return consentCookieObj;
}
/** Check the cookie preferences object.
 *
 * If the consent object is not present, malformed, or incorrect version,
 * returns false, otherwise returns true.
 */
export function isValidConsentCookie(options) {
    return (options && options.version >= window.GDS_CONSENT_COOKIE_VERSION);
}
/** Update the user's cookie preferences. */
export function setConsentCookie(options) {
    let cookieConsent = getConsentCookie();
    if (!cookieConsent) {
        cookieConsent = JSON.parse(JSON.stringify(DEFAULT_COOKIE_CONSENT));
    }
    // Merge current cookie preferences and new preferences
    for (var option in options) {
        cookieConsent[option] = options[option];
    }
    cookieConsent.version = window.GDS_CONSENT_COOKIE_VERSION;
    // Set the consent cookie
    setCookie(window.GA_COOKIE_NAME, encodeURIComponent(JSON.stringify(cookieConsent)), { days: 365 });
    // Update the other cookies
    resetCookies();
}
/** Apply the user's cookie preferences
 *
 * Deletes any cookies the user has not consented to.
 */
export function resetCookies() {
    var options = getConsentCookie();
    // If no preferences or old version use the default
    if (!isValidConsentCookie(options)) {
        options = JSON.parse(JSON.stringify(DEFAULT_COOKIE_CONSENT));
    }
    for (var cookieType in options) {
        if (cookieType === 'version') {
            continue;
        }
        // Essential cookies cannot be deselected, ignore this cookie type
        if (cookieType === 'essential') {
            continue;
        }
        if (!options[cookieType]) {
            // Fetch the cookies in that category
            var cookiesInCategory = COOKIE_CATEGORIES[cookieType];
            cookiesInCategory.forEach(function (cookie) {
                deleteCookie(cookie);
            });
        }
    }
}
function userAllowsCookieCategory(cookieCategory, cookiePreferences) {
    // Essential cookies are always allowed
    if (cookieCategory === 'essential') {
        return true;
    }
    // Sometimes cookiePreferences is malformed in some of the tests, so we need to handle these
    try {
        return cookiePreferences[cookieCategory];
    }
    catch (e) {
        console.error(e);
        return false;
    }
}
function userAllowsCookie(cookieName) {
    // Always allow setting the consent cookie
    if (cookieName === window.GA_COOKIE_NAME) {
        return true;
    }
    // Get the current cookie preferences
    var cookiePreferences = getConsentCookie();
    // If no preferences or old version use the default
    if (!isValidConsentCookie(cookiePreferences)) {
        cookiePreferences = DEFAULT_COOKIE_CONSENT;
    }
    for (var category in COOKIE_CATEGORIES) {
        var cookiesInCategory = COOKIE_CATEGORIES[category];
        if (cookiesInCategory.indexOf(cookieName) !== '-1') {
            return userAllowsCookieCategory(category, cookiePreferences);
        }
    }
    // Deny the cookie if it is not known to us
    return false;
}
function getCookie(name) {
    var nameEQ = name + '=';
    var cookies = document.cookie.split(';');
    for (var i = 0, len = cookies.length; i < len; i++) {
        var cookie = cookies[i];
        while (cookie.charAt(0) === ' ') {
            cookie = cookie.substring(1, cookie.length);
        }
        if (cookie.indexOf(nameEQ) === 0) {
            return decodeURIComponent(cookie.substring(nameEQ.length));
        }
    }
    return null;
}
// do we need to set the domain?
function setCookie(name, value, options) {
    if (userAllowsCookie(name)) {
        if (typeof options === 'undefined') {
            options = {};
        }
        var cookieString = name + '=' + value + '; path=/; SameSite=Strict';
        if (options.days) {
            var date = new Date();
            date.setTime(date.getTime() + (options.days * 24 * 60 * 60 * 1000));
            cookieString = cookieString + '; expires=' + date.toUTCString();
        }
        if (document.location.protocol === 'https:') {
            cookieString = cookieString + '; Secure';
        }
        document.cookie = cookieString;
    }
}
function deleteCookie(name) {
    if (getCookie(name)) {
        // Cookies need to be deleted in the same level of specificity in which they were set
        // If a cookie was set with a specified domain, it needs to be specified when deleted
        // If a cookie wasn't set with the domain attribute, it shouldn't be there when deleted
        // You can't tell if a cookie was set with a domain attribute or not, so try both options
        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;domain=' + window.location.hostname + ';path=/';
        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;domain=.' + window.location.hostname + ';path=/';
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvY29va2llLWZ1bmN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFlQSx1REFBdUQ7QUFDdkQsTUFBTSxpQkFBaUIsR0FBcUI7SUFDeEMsU0FBUyxFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDO0lBQ25EOzs7OztPQUtHO0lBQ0gsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQztDQUNyQyxDQUFBO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsTUFBTSxzQkFBc0IsR0FBa0I7SUFDMUMsU0FBUyxFQUFFLEtBQUs7SUFDaEIsT0FBTyxFQUFFLE1BQU0sQ0FBQywwQkFBMEI7Q0FDN0MsQ0FBQTtBQUVEOzs7O0dBSUc7QUFDSCxNQUFNLFVBQVUsZ0JBQWdCO0lBQzVCLE1BQU0sYUFBYSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDdkQsSUFBSSxnQkFBc0MsQ0FBQztJQUUzQyxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQztZQUNELGdCQUFnQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUNyRSxDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNYLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7SUFDTCxDQUFDO1NBQU0sQ0FBQztRQUNKLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxPQUFPLGdCQUFnQixDQUFDO0FBQzVCLENBQUM7QUFFRDs7OztHQUlHO0FBQ0gsTUFBTSxVQUFVLG9CQUFvQixDQUFDLE9BQXNCO0lBQ3ZELE9BQU8sQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sSUFBSSxNQUFNLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUM3RSxDQUFDO0FBRUQsNENBQTRDO0FBQzVDLE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxPQUFzQjtJ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SCxDQUFDO0FBQ0wsQ0FBQyIsImZpbGUiOiJjb21wb25lbnRzL2Nvb2tpZS1mdW5jdGlvbnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmV4cG9ydCBpbnRlcmZhY2UgQ29uc2VudENvb2tpZSB7XG4gICAgYW5hbHl0aWNzPzogYm9vbGVhbjtcbiAgICB2ZXJzaW9uPzogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgQ29va2llQ2F0ZWdvcmllcyB7XG4gICAgYW5hbHl0aWNzOiBzdHJpbmdbXTtcbiAgICBlc3NlbnRpYWw6IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgQ29va2llT3B0aW9ucyB7XG4gICAgZGF5cz86IG51bWJlcjtcbn1cblxuLyogVXNlcnMgY2FuIChkaXMpYWxsb3cgZGlmZmVyZW50IGdyb3VwcyBvZiBjb29raWVzLiAqL1xuY29uc3QgQ09PS0lFX0NBVEVHT1JJRVM6IENvb2tpZUNhdGVnb3JpZXMgPSB7XG4gICAgYW5hbHl0aWNzOiBbJ19nYScsICdfZ2FfJyArIHdpbmRvdy5HQV9DT05UQUlORVJfSURdLFxuICAgIC8qIEVzc2VudGlhbCBjb29raWVzXG4gICAgICpcbiAgICAgKiBFc3NlbnRpYWwgY29va2llcyBjYW5ub3QgYmUgZGVzZWxlY3RlZCwgYnV0IHdlIHdhbnQgb3VyIGNvb2tpZSBjb2RlIHRvXG4gICAgICogb25seSBhbGxvdyBhZGRpbmcgY29va2llcyB0aGF0IGFyZSBkb2N1bWVudGVkIGluIHRoaXMgb2JqZWN0LCBzbyB0aGV5IG5lZWRcbiAgICAgKiB0byBiZSBhZGRlZCBoZXJlLlxuICAgICAqL1xuICAgIGVzc2VudGlhbDogW3dpbmRvdy5HQV9DT09LSUVfTkFNRV1cbn1cblxuLypcbiAqIERlZmF1bHQgY29va2llIHByZWZlcmVuY2VzIGlmIHVzZXIgaGFzIG5vIGNvb2tpZSBwcmVmZXJlbmNlcy5cbiAqXG4gKiBOb3RlIHRoYXQgdGhpcyBkb2Vzbid0IGluY2x1ZGUgYSBrZXkgZm9yIGVzc2VudGlhbCBjb29raWVzLCBlc3NlbnRpYWxcbiAqIGNvb2tpZXMgY2Fubm90IGJlIGRpc2FsbG93ZWQuIElmIHRoZSBvYmplY3QgY29udGFpbnMgeyBlc3NlbnRpYWw6IGZhbHNlIH1cbiAqIHRoaXMgd2lsbCBiZSBpZ25vcmVkLlxuICovXG5jb25zdCBERUZBVUxUX0NPT0tJRV9DT05TRU5UOiBDb25zZW50Q29va2llID0ge1xuICAgIGFuYWx5dGljczogZmFsc2UsXG4gICAgdmVyc2lvbjogd2luZG93LkdEU19DT05TRU5UX0NPT0tJRV9WRVJTSU9OXG59XG5cbi8qKiBSZXR1cm4gdGhlIHVzZXIncyBjb29raWUgcHJlZmVyZW5jZXMuXG4gKlxuICogSWYgdGhlIGNvbnNlbnQgY29va2llIGlzIG1hbGZvcm1lZCwgb3Igbm90IHByZXNlbnQsXG4gKiByZXR1cm5zIG51bGwuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb25zZW50Q29va2llKCk6IENvbnNlbnRDb29raWUgfCBudWxsIHtcbiAgICBjb25zdCBjb25zZW50Q29va2llID0gZ2V0Q29va2llKHdpbmRvdy5HQV9DT09LSUVfTkFNRSk7XG4gICAgbGV0IGNvbnNlbnRDb29raWVPYmo6IENvbnNlbnRDb29raWUgfCBudWxsO1xuXG4gICAgaWYgKGNvbnNlbnRDb29raWUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnNlbnRDb29raWVPYmogPSBKU09OLnBhcnNlKGRlY29kZVVSSUNvbXBvbmVudChjb25zZW50Q29va2llKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gY29uc2VudENvb2tpZU9iajtcbn1cblxuLyoqIENoZWNrIHRoZSBjb29raWUgcHJlZmVyZW5jZXMgb2JqZWN0LlxuICpcbiAqIElmIHRoZSBjb25zZW50IG9iamVjdCBpcyBub3QgcHJlc2VudCwgbWFsZm9ybWVkLCBvciBpbmNvcnJlY3QgdmVyc2lvbixcbiAqIHJldHVybnMgZmFsc2UsIG90aGVyd2lzZSByZXR1cm5zIHRydWUuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1ZhbGlkQ29uc2VudENvb2tpZShvcHRpb25zOiBDb25zZW50Q29va2llKSB7XG4gICAgcmV0dXJuIChvcHRpb25zICYmIG9wdGlvbnMudmVyc2lvbiA+PSB3aW5kb3cuR0RTX0NPTlNFTlRfQ09PS0lFX1ZFUlNJT04pO1xufVxuXG4vKiogVXBkYXRlIHRoZSB1c2VyJ3MgY29va2llIHByZWZlcmVuY2VzLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldENvbnNlbnRDb29raWUob3B0aW9uczogQ29uc2VudENvb2tpZSkge1xuICAgIGxldCBjb29raWVDb25zZW50ID0gZ2V0Q29uc2VudENvb2tpZSgpO1xuXG4gICAgaWYgKCFjb29raWVDb25zZW50KSB7XG4gICAgICAgIGNvb2tpZUNvbnNlbnQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KERFRkFVTFRfQ09PS0lFX0NPTlNFTlQpKTtcbiAgICB9XG5cbiAgICAvLyBNZXJnZSBjdXJyZW50IGNvb2tpZSBwcmVmZXJlbmNlcyBhbmQgbmV3IHByZWZlcmVuY2VzXG4gICAgZm9yICh2YXIgb3B0aW9uIGluIG9wdGlvbnMpIHtcbiAgICAgICAgY29va2llQ29uc2VudFtvcHRpb25dID0gb3B0aW9uc1tvcHRpb25dO1xuICAgIH1cblxuICAgIGNvb2tpZUNvbnNlbnQudmVyc2lvbiA9IHdpbmRvdy5HRFNfQ09OU0VOVF9DT09LSUVfVkVSU0lPTjtcblxuICAgIC8vIFNldCB0aGUgY29uc2VudCBjb29raWVcbiAgICBzZXRDb29raWUod2luZG93LkdBX0NPT0tJRV9OQU1FLCBlbmNvZGVVUklDb21wb25lbnQoSlNPTi5zdHJpbmdpZnkoY29va2llQ29uc2VudCkpLCB7IGRheXM6IDM2NSB9KTtcblxuICAgIC8vIFVwZGF0ZSB0aGUgb3RoZXIgY29va2llc1xuICAgIHJlc2V0Q29va2llcygpO1xufVxuXG4vKiogQXBwbHkgdGhlIHVzZXIncyBjb29raWUgcHJlZmVyZW5jZXNcbiAqXG4gKiBEZWxldGVzIGFueSBjb29raWVzIHRoZSB1c2VyIGhhcyBub3QgY29uc2VudGVkIHRvLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVzZXRDb29raWVzKCkge1xuICAgIHZhciBvcHRpb25zID0gZ2V0Q29uc2VudENvb2tpZSgpO1xuXG4gICAgLy8gSWYgbm8gcHJlZmVyZW5jZXMgb3Igb2xkIHZlcnNpb24gdXNlIHRoZSBkZWZhdWx0XG4gICAgaWYgKCFpc1ZhbGlkQ29uc2VudENvb2tpZShvcHRpb25zKSkge1xuICAgICAgICBvcHRpb25zID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShERUZBVUxUX0NPT0tJRV9DT05TRU5UKSk7XG4gICAgfVxuXG4gICAgZm9yICh2YXIgY29va2llVHlwZSBpbiBvcHRpb25zKSB7XG4gICAgICAgIGlmIChjb29raWVUeXBlID09PSAndmVyc2lvbicpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRXNzZW50aWFsIGNvb2tpZXMgY2Fubm90IGJlIGRlc2VsZWN0ZWQsIGlnbm9yZSB0aGlzIGNvb2tpZSB0eXBlXG4gICAgICAgIGlmIChjb29raWVUeXBlID09PSAnZXNzZW50aWFsJykge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIW9wdGlvbnNbY29va2llVHlwZV0pIHtcbiAgICAgICAgICAgIC8vIEZldGNoIHRoZSBjb29raWVzIGluIHRoYXQgY2F0ZWdvcnlcbiAgICAgICAgICAgIHZhciBjb29raWVzSW5DYXRlZ29yeSA9IENPT0tJRV9DQVRFR09SSUVTW2Nvb2tpZVR5cGVdXG5cbiAgICAgICAgICAgIGNvb2tpZXNJbkNhdGVnb3J5LmZvckVhY2goZnVuY3Rpb24gKGNvb2tpZSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZUNvb2tpZShjb29raWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIHVzZXJBbGxvd3NDb29raWVDYXRlZ29yeShjb29raWVDYXRlZ29yeSwgY29va2llUHJlZmVyZW5jZXMpIHtcbiAgICAvLyBFc3NlbnRpYWwgY29va2llcyBhcmUgYWx3YXlzIGFsbG93ZWRcbiAgICBpZiAoY29va2llQ2F0ZWdvcnkgPT09ICdlc3NlbnRpYWwnKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFNvbWV0aW1lcyBjb29raWVQcmVmZXJlbmNlcyBpcyBtYWxmb3JtZWQgaW4gc29tZSBvZiB0aGUgdGVzdHMsIHNvIHdlIG5lZWQgdG8gaGFuZGxlIHRoZXNlXG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGNvb2tpZVByZWZlcmVuY2VzW2Nvb2tpZUNhdGVnb3J5XTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHVzZXJBbGxvd3NDb29raWUoY29va2llTmFtZTogc3RyaW5nKSB7XG4gICAgLy8gQWx3YXlzIGFsbG93IHNldHRpbmcgdGhlIGNvbnNlbnQgY29va2llXG4gICAgaWYgKGNvb2tpZU5hbWUgPT09IHdpbmRvdy5HQV9DT09LSUVfTkFNRSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBHZXQgdGhlIGN1cnJlbnQgY29va2llIHByZWZlcmVuY2VzXG4gICAgdmFyIGNvb2tpZVByZWZlcmVuY2VzID0gZ2V0Q29uc2VudENvb2tpZSgpO1xuXG4gICAgLy8gSWYgbm8gcHJlZmVyZW5jZXMgb3Igb2xkIHZlcnNpb24gdXNlIHRoZSBkZWZhdWx0XG4gICAgaWYgKCFpc1ZhbGlkQ29uc2VudENvb2tpZShjb29raWVQcmVmZXJlbmNlcykpIHtcbiAgICAgICAgY29va2llUHJlZmVyZW5jZXMgPSBERUZBVUxUX0NPT0tJRV9DT05TRU5UO1xuICAgIH1cblxuICAgIGZvciAodmFyIGNhdGVnb3J5IGluIENPT0tJRV9DQVRFR09SSUVTKSB7XG4gICAgICAgIHZhciBjb29raWVzSW5DYXRlZ29yeSA9IENPT0tJRV9DQVRFR09SSUVTW2NhdGVnb3J5XTtcblxuICAgICAgICBpZiAoY29va2llc0luQ2F0ZWdvcnkuaW5kZXhPZihjb29raWVOYW1lKSAhPT0gJy0xJykge1xuICAgICAgICAgICAgcmV0dXJuIHVzZXJBbGxvd3NDb29raWVDYXRlZ29yeShjYXRlZ29yeSwgY29va2llUHJlZmVyZW5jZXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gRGVueSB0aGUgY29va2llIGlmIGl0IGlzIG5vdCBrbm93biB0byB1c1xuICAgIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29va2llKG5hbWU6IHN0cmluZykge1xuICAgIHZhciBuYW1lRVEgPSBuYW1lICsgJz0nO1xuICAgIHZhciBjb29raWVzID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCc7Jyk7XG4gICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNvb2tpZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgdmFyIGNvb2tpZSA9IGNvb2tpZXNbaV07XG4gICAgICAgIHdoaWxlIChjb29raWUuY2hhckF0KDApID09PSAnICcpIHtcbiAgICAgICAgICAgIGNvb2tpZSA9IGNvb2tpZS5zdWJzdHJpbmcoMSwgY29va2llLmxlbmd0aCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvb2tpZS5pbmRleE9mKG5hbWVFUSkgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoY29va2llLnN1YnN0cmluZyhuYW1lRVEubGVuZ3RoKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59XG5cbi8vIGRvIHdlIG5lZWQgdG8gc2V0IHRoZSBkb21haW4/XG5mdW5jdGlvbiBzZXRDb29raWUobmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nLCBvcHRpb25zPzogQ29va2llT3B0aW9ucykge1xuICAgIGlmICh1c2VyQWxsb3dzQ29va2llKG5hbWUpKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7fVxuICAgICAgICB9XG4gICAgICAgIHZhciBjb29raWVTdHJpbmcgPSBuYW1lICsgJz0nICsgdmFsdWUgKyAnOyBwYXRoPS87IFNhbWVTaXRlPVN0cmljdCc7XG4gICAgICAgIGlmIChvcHRpb25zLmRheXMpIHtcbiAgICAgICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgIGRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIChvcHRpb25zLmRheXMgKiAyNCAqIDYwICogNjAgKiAxMDAwKSk7XG4gICAgICAgICAgICBjb29raWVTdHJpbmcgPSBjb29raWVTdHJpbmcgKyAnOyBleHBpcmVzPScgKyBkYXRlLnRvVVRDU3RyaW5nKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRvY3VtZW50LmxvY2F0aW9uLnByb3RvY29sID09PSAnaHR0cHM6Jykge1xuICAgICAgICAgICAgY29va2llU3RyaW5nID0gY29va2llU3RyaW5nICsgJzsgU2VjdXJlJztcbiAgICAgICAgfVxuICAgICAgICBkb2N1bWVudC5jb29raWUgPSBjb29raWVTdHJpbmc7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBkZWxldGVDb29raWUobmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKGdldENvb2tpZShuYW1lKSkge1xuICAgICAgICAvLyBDb29raWVzIG5lZWQgdG8gYmUgZGVsZXRlZCBpbiB0aGUgc2FtZSBsZXZlbCBvZiBzcGVjaWZpY2l0eSBpbiB3aGljaCB0aGV5IHdlcmUgc2V0XG4gICAgICAgIC8vIElmIGEgY29va2llIHdhcyBzZXQgd2l0aCBhIHNwZWNpZmllZCBkb21haW4sIGl0IG5lZWRzIHRvIGJlIHNwZWNpZmllZCB3aGVuIGRlbGV0ZWRcbiAgICAgICAgLy8gSWYgYSBjb29raWUgd2Fzbid0IHNldCB3aXRoIHRoZSBkb21haW4gYXR0cmlidXRlLCBpdCBzaG91bGRuJ3QgYmUgdGhlcmUgd2hlbiBkZWxldGVkXG4gICAgICAgIC8vIFlvdSBjYW4ndCB0ZWxsIGlmIGEgY29va2llIHdhcyBzZXQgd2l0aCBhIGRvbWFpbiBhdHRyaWJ1dGUgb3Igbm90LCBzbyB0cnkgYm90aCBvcHRpb25zXG4gICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IG5hbWUgKyAnPTtleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UO3BhdGg9Lyc7XG4gICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IG5hbWUgKyAnPTtleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UO2RvbWFpbj0nICsgd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lICsgJztwYXRoPS8nO1xuICAgICAgICBkb2N1bWVudC5jb29raWUgPSBuYW1lICsgJz07ZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVDtkb21haW49LicgKyB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUgKyAnO3BhdGg9Lyc7XG4gICAgfVxufSJdfQ==
