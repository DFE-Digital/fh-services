# Family Hubs | VC&F

## Folder Structure

```
.
├── local <-- Files needed to run fh locally
├── src
│   ├── function <-- Serverless functions
│   ├── service <-- API services
│   ├── shared <-- Shared libraries
│   └── ui <-- UI apps
├── util <-- Utility scripts for common use cases
├── docs <-- Technical documentation
├── terraform <-- Terraform (IaC) scripts for the Family Hubs architecture
└── test <-- Scripts/frameworks relating to testing
```

## Documentation

- [High Level Design Document](/docs/hld.md)
- [HSDS v3.0 entity relationships](/docs/hsds-3_0-er-diagram.md)
- [Architecture Decision Records](/docs/arch)

**Note:** Specific documentation on each lib, service, API and others can be found within the `src/` folder.

## Building & Running

### Docker

The project can be ran with Docker. Each API and UI contains a Dockerfile and is orchestrated by a Docker Compose file.

See the `README.md` in [/local/README.md](/local/README.md) for instructions on how to run the project in Docker and seed test data into the database.

### Native

⚠️ Before continuing, firstly set up your environment by following the [prerequisites section](#prerequisites). ⚠️

#### Building

To build each project, you can navigate to the `SuperSolution.sln` root and run a `dotnet build`.

Alternatively, you can navigate to an individual projects `.csproj` and `dotnet build` that.

#### Appsettings

Each API & UI has an `appsettings.json` file. It's recommended to use .NET User Secrets instead of editing these, but fundamentally you will need to do this for each project:

- To change the connection strings of the databases to match your setup. It will generally be in the form of: `"Server=localhost,1433;User Id=<USER>;Password=<PASSWORD>;Initial Catalog=FamilyHubs.<API>.Database;MultipleActiveResultSets=True;TrustServerCertificate=true;Pooling=False;Connect Timeout=10;"`
- Set `Crypto--UseKeyVault` to `false`
- Set `Crypto--DbEncryptionKey` to a generated value*
- Set `Crypto--DbEncryptionIVKey` to a generated value*

\* These keys can be generated by running the `IdAM Maintenance UI` (it does not need anything else running for this step). In there navigate to "[Create New Encryption Keys](https://localhost:7220/CreateEncryptionKeys)" - it will then generate the two Crypto keys. Simply use these two keys in all the projects.

#### Database Migrations

For the first time you run the project, or whenever database changes are made, you will need to run the migrations.

To do this, for each API* in the [src/service](/src/service/) folder, substituting where necessary:

- CD into the `FamilyHubs.<PROJECT>.Data` folder.
- Run the command: `dotnet ef database update --startup-project ../FamilyHubs.<PROJECT>.Api/FamilyHubs.<PROJECT>.Api.csproj --project FamilyHubs.<PROJECT>.Data.csproj`

\* For the Mock HSDA API you can simply run `dotnet ef database update`

Once the databases are all up and running, you can optionally navigate to [/test/e2e-seed-data-framework](/test/e2e-seed-data-framework/). You will need to make a copy of `.env.local` and name it `.env`, and then fill out the connection strings as per your environment, as well as fill out the two local encryption keys that were generated from the IdAM Maintenance UI. Once done, run the seeding script with `npm run setup:dev`.

#### Running

Each API and UI can be ran by navigating into its `Program.cs` root and running `dotnet run`. The list of runnable projects are as follows:

##### API
- [IdAM API](/src/service/idam-api/src/FamilyHubs.Idam.Api/)
- [Mock HSDA API](/src/service/mock-hsda-api/src/FamilyHubs.Mock-Hsda.Api/)
- [Notification API](/src/service/notification-api/src/FamilyHubs.Notification.Api/)
- [Referral API](/src/service/referral-api/src/FamilyHubs.Referral.Api/)
- [Service Directory API](/src/service/service-directory-api/src/FamilyHubs.ServiceDirectory.Api/)

##### UI

- [Connect UI](/src/ui/connect-ui/src/FamilyHubs.Referral.Web/) (AKA. Single Directory)
- [IdAM Maintenance UI](/src/ui/idam-maintenance-ui/src/FamilyHubs.Idams.Maintenance.UI/)
- [Manage UI](/src/ui/manage-ui/src/FamilyHubs.ServiceDirectory.Admin.Web/)

## Prerequisites

#### Tooling

- .NET 8 SDK and the ASP.NET 8.0 Runtime.
- Node LTS of at least version 20 (Iron) or above.
- Microsoft SQL Server 2022. This can be run natively on Windows, on MacOS there is a Docker compose YAML at [/local/db](/local/db/) that can be ran with `docker compose up -d`. For ARM based Macs (Apple Silicon), ensure Rosetta is enabled for Docker. Ensure this is always running in the background.

##### Entity Framework

Install the Entity Framework tools with `dotnet tool install --global dotnet-ef`

##### Node

The UIs contain packages that need to be ran. Navigating to the [shared web components library](/src/shared/web-components/src/familyhubs-frontend/) and running `npm i` should generate the library. Then in each UI (see the list of runnable UI projects above for the root folder) run `npm i`.

Changes to JS or CSS require gulp tasks to be ran in each UI and the shared web component library.

#### The SpatiaLite Library

We use SpatiaLite for geo-spatial calculations when running SQLite, such as when running the Functional/Integration tests in the Service Directory and Referral APIs. On some operating systems there is additional configuration required:

##### Windows

- No configuration required.

##### MacOS

 - Install Dependencies with Brew: `brew install sqlite libspatialite`.
 - When running tests, set the `DYLD_LIBRARY_PATH` environment variable to the path `libspatialite` is installed. At the time of writing this is `/opt/homebrew/Cellar/libspatialite/5.1.0_1/lib`.
 - If running tests in the terminal, this can be done by exporting the variable. E.g., `export DYLD_LIBRARY_PATH=/opt/homebrew/Cellar/libspatialite/5.1.0_1/lib` and then running `dotnet test`.
 - If running tests through your IDEs GUI, your mileage may vary as configuration is IDE-specific. For Rider it's under `Settings... -> Build, Execution, Deployment -> Unit Testing -> Test Runner`. In there there is an `Environment variables` section where you can add the Name and Value.


 ##### Linux (Ubuntu)

 - Update your package list: `apt update`
 - Install SpatiaLite: `apt install libspatialite-dev libsqlite3-mod-spatialite`
 - Update the shared library cache: `ldconfig "/usr/lib/x86_64-linux-gnu/mod_spatialite.so"`

## License

Please see the `LICENSE` file for information on licensing.
